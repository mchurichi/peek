name: "Release: Validate Labels And Suggest Bump"

on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited, labeled, unlabeled, ready_for_review]

jobs:
  validate-release-context:
    name: Validate Release Labels And Suggest Bump
    runs-on: ubuntu-latest
    concurrency:
      group: release-label-suggestion-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute release context
        id: release_context
        uses: ./.github/actions/compute-release-context
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-title: ${{ github.event.pull_request.title }}
          pr-body: ${{ github.event.pull_request.body }}
          pr-labels-json: ${{ toJSON(github.event.pull_request.labels) }}
          include-suggestion: 'true'

      - name: Upsert release suggestion comment and enforce label policy
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const issueNumber = pr.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = '<!-- peek-release-label-suggestion -->';
            const policyOk = '${{ steps.release_context.outputs.policy_ok }}' === 'true';
            const suggestedLabel = '${{ steps.release_context.outputs.suggested_label }}';
            const predictedTagDisplay = '${{ steps.release_context.outputs.suggested_next_tag_display }}';
            const suggestionReason = `${{ steps.release_context.outputs.suggestion_reason }}`;
            const source = '${{ steps.release_context.outputs.suggestion_source }}';
            const signature = `${{ steps.release_context.outputs.signature }}`;

            const body = [
              marker,
              '### Release Label Suggestion',
              '',
              `Suggested label: \`${suggestedLabel}\``,
              `If merged now, estimated next tag: \`${predictedTagDisplay}\``,
              `Why: ${suggestionReason} (source: ${source})`,
              '',
              'You can change this by updating PR labels before merge.',
              '',
              'Allowed labels (exactly one required):',
              '- `release:patch`',
              '- `release:minor`',
              '- `release:major`',
              '- `skip-release`',
              '',
              `<!-- signature:${signature} -->`,
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const botComment = comments.find(c =>
              c.user?.type === 'Bot' &&
              typeof c.body === 'string' &&
              c.body.includes(marker)
            );

            const oldSigMatch = botComment?.body?.match(/<!-- signature:(.*?) -->/);
            const oldSignature = oldSigMatch ? oldSigMatch[1] : null;

            if (oldSignature !== signature) {
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body,
                });
              }
            }

            if (!policyOk) {
              core.setFailed('Exactly one release label is required to merge: release:patch, release:minor, release:major, or skip-release.');
            }
