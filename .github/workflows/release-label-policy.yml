name: Release Label Policy

on:
  pull_request_target:
    types: [opened, reopened, synchronize, edited, labeled, unlabeled, ready_for_review]

jobs:
  validate-release-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate labels and suggest bump
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const issueNumber = pr.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = '<!-- peek-release-label-suggestion -->';
            const releaseUtils = require('./.github/scripts/release-utils.cjs');

            const uniqueMatchedLabels = releaseUtils.releaseLabels(pr.labels || []);
            const policyOk = uniqueMatchedLabels.length === 1;

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner,
              repo,
              pull_number: issueNumber,
              per_page: 100,
            });
            const suggestion = releaseUtils.suggestBump({
              title: pr.title,
              body: pr.body,
              commits,
            });

            const suggestedLabel = releaseUtils.BUMP_TO_LABEL[suggestion.bump];
            const source = suggestion.source;

            const tags = await github.paginate(github.rest.repos.listTags, {
              owner,
              repo,
              per_page: 100,
            });
            const predictedTag = releaseUtils.nextTag(
              tags.map(t => t.name),
              suggestion.bump,
            );

            const signature = `${suggestedLabel}|${predictedTag}|${suggestion.reason}|${source}`;

            const body = [
              marker,
              '### Release Label Suggestion',
              '',
              `Suggested label: \`${suggestedLabel}\``,
              `If merged now, estimated next tag: \`${predictedTag}\``,
              `Why: ${suggestion.reason} (source: ${source})`,
              '',
              'You can change this by updating PR labels before merge.',
              '',
              'Allowed labels (exactly one required):',
              '- `release:patch`',
              '- `release:minor`',
              '- `release:major`',
              '- `skip-release`',
              '',
              `<!-- signature:${signature} -->`,
            ].join('\n');

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: issueNumber,
              per_page: 100,
            });

            const botComment = comments.find(c =>
              c.user?.type === 'Bot' &&
              typeof c.body === 'string' &&
              c.body.includes(marker)
            );

            const oldSigMatch = botComment?.body?.match(/<!-- signature:(.*?) -->/);
            const oldSignature = oldSigMatch ? oldSigMatch[1] : null;

            if (oldSignature !== signature) {
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: botComment.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body,
                });
              }
            }

            if (!policyOk) {
              core.setFailed('Exactly one release label is required to merge: release:patch, release:minor, release:major, or skip-release.');
            }
